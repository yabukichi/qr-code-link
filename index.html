<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QRリンクオープナー</title>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.5;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #f5f7ff, #d7e1ec);
      color: #111;
    }

    .card {
      width: min(960px, 95vw);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.35);
      padding: 28px;
      backdrop-filter: blur(12px);
      display: flex;
      flex-direction: column;
    }

    .header-section {
      text-align: center;
      margin-bottom: 20px;
    }

    .main-content {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    .scanner-section {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .result-section {
      flex: 1.5;
      min-width: 300px;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }

      .result-section {
        width: 100%;
        margin-top: 20px;
      }
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 6px;
    }

    .hint {
      font-size: 0.92rem;
      color: #334155;
      margin: 0;
    }

    #reader {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: #0f172a;
    }

    .status {
      margin: 18px 0 4px;
      font-weight: 600;
      color: #0f172a;
    }

    .log {
      font-size: 0.9rem;
      padding: 12px;
      border: 1px solid #cbd5f5;
      border-radius: 10px;
      background: #f8fbff;
      min-height: 48px;
      word-break: break-all;
    }

    #reader video {
      transform: scaleX(-1);
    }

    iframe {
      width: 100%;
      height: 100%;
      min-height: 500px;
      border: 1px solid #cbd5f5;
      border-radius: 12px;
      background: white;
      flex-grow: 1;
    }

    /* Fallback button controls */
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 0 4px;
    }

    .result-url {
      font-size: 0.85rem;
      color: #64748b;
      max-width: 60%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .open-tab-btn {
      text-decoration: none;
      background: #eff6ff;
      color: #2563eb;
      border: 1px solid #2563eb;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      display: none;
      /* Hidden by default */
    }

    .open-tab-btn:hover {
      background: #2563eb;
      color: #fff;
    }

    .open-tab-btn.show {
      display: inline-block;
    }

    button {
      margin-top: 16px;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
    }

    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>

<body>
  <main class="card">
    <div class="header-section">
      <h1>QRを読み込んで表示 (左右反転)</h1>
      <p class="hint">カメラ使用を許可して、URLが含まれるQRコードをかざしてください。</p>
    </div>

    <div class="main-content">
      <div class="scanner-section">
        <div id="reader"></div>
        <p class="status" id="status">カメラ準備中...</p>
        <div class="log" id="log">まだ読み取りはありません。</div>
        <button id="toggle">停止する</button>
      </div>

      <div class="result-section">
        <div class="result-header">
          <span class="result-url" id="result-url"></span>
          <a id="open-new-tab" class="open-tab-btn" target="_blank" href="#">別タブで開く</a>
        </div>
        <iframe id="result-frame" title="Scan Result"></iframe>
      </div>
    </div>
  </main>

  <script>
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const toggleBtn = document.getElementById("toggle");
    const resultFrame = document.getElementById("result-frame");
    const openTabBtn = document.getElementById("open-new-tab");
    const resultUrlEl = document.getElementById("result-url");

    let qrReader;
    let running = true;
    let lastScanText = "";
    let lastScanAt = 0;
    const COOLDOWN_MS = 2000;

    let currentTargetUrl = "";
    let iframeLoadTimeout = null;
    let hasOpenedInNewTab = false;
    const IFRAME_LOAD_TIMEOUT_MS = 5000; // 5秒以内に読み込めなければ別タブで開く

    function isLikelyUrl(text) {
      try {
        const url = new URL(text.startsWith("http") ? text : `https://${text}`);
        return url.protocol === "http:" || url.protocol === "https:";
      } catch (_) {
        return false;
      }
    }

    function setStatus(message) {
      statusEl.textContent = message;
    }

    // 別タブで開く処理
    function openInNewTab(url, reason = "") {
      if (hasOpenedInNewTab || !url) return;
      hasOpenedInNewTab = true;

      window.open(url, '_blank');
      setStatus(`⚠️ iframeで表示できなかったため、別タブで開きました${reason ? ` (${reason})` : ""}`);

      // iframeは空白にリセット
      resultFrame.src = "about:blank";
    }

    // iframeの読み込み状態をチェック
    function checkIframeLoadStatus() {
      if (!currentTargetUrl || hasOpenedInNewTab) return;

      try {
        // 同一オリジンの場合のみアクセス可能
        const doc = resultFrame.contentDocument || resultFrame.contentWindow.document;

        // bodyが空またはエラーページの場合
        if (doc && doc.body) {
          const bodyContent = doc.body.innerHTML.trim();
          // 完全に空の場合はブロックされた可能性が高い
          if (bodyContent === '' || doc.body.innerText.trim() === '') {
            openInNewTab(currentTargetUrl, "コンテンツが空");
            return;
          }
        }

        // 正常に読み込まれた
        analyzeIframeContent();
      } catch (e) {
        // クロスオリジンでアクセスできない場合
        // 正常に読み込まれた可能性があるので、エラーとはしない
        setStatus("⚠️ 結果を表示しました (外部サイトのため自動判定できません)");
      }
    }

    // iframeのエラーハンドリング
    resultFrame.addEventListener("error", () => {
      if (currentTargetUrl && !hasOpenedInNewTab) {
        openInNewTab(currentTargetUrl, "読み込みエラー");
      }
    });

    // HTML解析による判定ロジック (同一オリジンでのみ動作)
    function analyzeIframeContent() {
      try {
        // クロスオリジン(別ドメイン)の場合はここでエラーになりcatchブロックへ移動します
        const doc = resultFrame.contentDocument || resultFrame.contentWindow.document;

        if (!doc) return;

        // ここに判定ロジックを実装します
        // 例: 特定のキーワードが含まれているか確認
        const bodyText = doc.body.innerText;
        console.log("iframe content:", bodyText);

        // 仮の判定ロジック
        // 本番環境に合わせて条件を書き換えてください
        if (bodyText.includes("成功") || bodyText.includes("完了")) {
          setStatus("✅ 処理が完了しました (HTML解析: 成功)");
          toggleBtn.style.backgroundColor = "#10b981"; // Green
        } else if (bodyText.includes("エラー") || bodyText.includes("失敗")) {
          setStatus("⚠️ エラーが発生した可能性があります (HTML解析: 失敗)");
          toggleBtn.style.backgroundColor = "#ef4444"; // Red
        } else {
          setStatus("HTMLを取得しました。判定条件に該当しませんでした。");
        }

      } catch (e) {
        // クロスオリジン制限やX-Frame-Optionsによりアクセスできない場合
        console.log("Cannot access iframe content:", e);
        setStatus("⚠️ 結果を表示しました (外部サイトのため自動判定できません)");
      }
    }

    resultFrame.addEventListener("load", () => {
      // タイムアウトをクリア
      if (iframeLoadTimeout) {
        clearTimeout(iframeLoadTimeout);
        iframeLoadTimeout = null;
      }

      // iframeの読み込み完了時に解析を試みる
      // about:blank の場合は無視
      if (resultFrame.src !== "about:blank" && resultFrame.src !== "") {
        // 少し待ってから状態をチェック（レンダリング完了を待つ）
        setTimeout(() => {
          checkIframeLoadStatus();
        }, 500);
      }
    });

    async function startScanner() {
      qrReader = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: { width: 240, height: 240 } };

      const onScanSuccess = (decodedText) => {
        if (!decodedText) return;

        const now = Date.now();
        if (decodedText === lastScanText && now - lastScanAt < COOLDOWN_MS) {
          return;
        }

        lastScanText = decodedText;
        lastScanAt = now;
        logEl.textContent = decodedText;

        // 色をリセット
        toggleBtn.style.backgroundColor = "";

        if (isLikelyUrl(decodedText)) {
          const target = decodedText.startsWith("http") ? decodedText : `https://${decodedText}`;
          setStatus("URLを検出しました。読み込み中...");

          // 前回のタイムアウトをクリア
          if (iframeLoadTimeout) {
            clearTimeout(iframeLoadTimeout);
          }

          // 状態をリセット
          currentTargetUrl = target;
          hasOpenedInNewTab = false;

          // Update iframe
          resultFrame.src = target;

          // 読み込みタイムアウトを設定
          // 一定時間内にloadイベントが発火しなければ別タブで開く
          iframeLoadTimeout = setTimeout(() => {
            if (!hasOpenedInNewTab && currentTargetUrl === target) {
              openInNewTab(target, "タイムアウト");
            }
          }, IFRAME_LOAD_TIMEOUT_MS);

          // Update fallback button
          openTabBtn.href = target;
          openTabBtn.classList.add("show");
          resultUrlEl.textContent = target;

        } else {
          setStatus("URL以外のQRコードを検出しました。");
          resultFrame.src = "about:blank";
          openTabBtn.classList.remove("show");
          resultUrlEl.textContent = "";

          // 状態をリセット
          currentTargetUrl = "";
          hasOpenedInNewTab = false;
          if (iframeLoadTimeout) {
            clearTimeout(iframeLoadTimeout);
            iframeLoadTimeout = null;
          }
        }
      };

      const onScanFailure = () => { };

      try {
        await qrReader.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
        setStatus("読み取り中... (カメラは左右反転しています)");
      } catch (err) {
        logEl.textContent = `エラー: ${err?.message || err}`;
        setStatus("カメラを開始できませんでした。");
        toggleBtn.disabled = true;
      }
    }

    toggleBtn.addEventListener("click", async () => {
      if (!qrReader) return;
      toggleBtn.disabled = true;
      if (running) {
        await qrReader.stop();
        qrReader.clear();
        running = false;
        toggleBtn.textContent = "再開する";
        setStatus("一時停止中。");
      } else {
        await startScanner();
        running = true;
        toggleBtn.textContent = "停止する";
      }
      toggleBtn.disabled = false;
    });

    window.addEventListener("load", startScanner);
  </script>
</body>

</html>